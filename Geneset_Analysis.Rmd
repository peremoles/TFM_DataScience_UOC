---
title: "Analysis of GSVA scores applied to a SpatialExperiment object"
author: "Pere Moles"
date: "2024-04-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, messages = FALSE, warnings = FALSE, verbose = FALSE)
```

# Load libraries
```{r,message=FALSE}
options(timeout=180)
library(ggspavis)
library(scran)
library(scater)
library(SpatialExperiment)
library(SpatialFeatureExperiment)
library(Voyager)
library(patchwork)
library(nnSVG)
library(here)
```

```{r}
# Function  for comparison between GSVA scores and clusters
source(here("GSVA_package","gsva_cluster_tests.R"))
```

# Read files


```{r}
# Cleaned and preprocessed SpatialExperiment object
spe <- readRDS("spe.rds")
# Genesets
genesets <- readRDS("genesets.rds")

# SpatialExperiment object with GSVA scores

res <- readRDS("gsva_res.rds")
```

# Get spatially variable genesets



## GSVA SpatialFeatureExperiment object


```{r}


gsva_sfe <- toSpatialFeatureExperiment(res)
colGraph(gsva_sfe, "visium", sample_id = "MouseBrainSagittalAnterior1") <- findVisiumGraph(gsva_sfe, sample_id = "MouseBrainSagittalAnterior1", zero.policy = TRUE)

```

## Compute Moran's I for GSVA scores

```{r}
assays(gsva_sfe)$logcounts <- assays(gsva_sfe)$es
moran_res <- runUnivariate(gsva_sfe, type = "moran", colGraphName = "visium")
```

```{r}
rowData(moran_res)[order(rowData(moran_res)$moran_MouseBrainSagittalAnterior1,decreasing = TRUE),][1:10,2:3]
```
### Plot Top 10 Spatially Autocorrelated Genesets

```{r}

top_SVG_genesets <- rownames(rowData(moran_res)[order(rowData(moran_res)$moran_MouseBrainSagittalAnterior1,decreasing = TRUE),][1:10,])
plot_list_hist_gsva <- lapply(top_SVG_genesets, function(x){
  pl <- plotVisium(res,y_coord = "pxl_col_in_fullres", x_coord = "pxl_row_in_fullres", fill = x, assay = "es",sample_ids=NULL) + ggtitle(paste0(x," GSVA scores superposed in histological image" ))+ theme(text = element_text(size = 7))
  pl
})
```

Clusters plot
```{r}
library(RColorBrewer)
cluster_plot <- plotVisium(spe,y_coord = "pxl_col_in_fullres", x_coord = "pxl_row_in_fullres", fill = "label", palette = brewer.pal(9, "Set1"))+labs(subtitle=NULL)+ggtitle("Cluster regions")+ theme(text = element_text(size = 7))
```

```{r, out.width="300%"}
for (i in 1:length(plot_list_hist_gsva)){
    print(plot_list_hist_gsva[[i]]+cluster_plot)
}
```

## Compute NNSVG for GSVA scores

```{r}
spe_nnSVG <- readRDS("nnsvg_res.rds")
```

```{r}
rowData(spe_nnSVG)[order(rowData(spe_nnSVG)$rank,decreasing = TRUE),][1:10,2:15]
```

## Plot Top 10 Spatially Variable Genesets

```{r}
top_nnSVG_genesets <- rownames(rowData(spe_nnSVG)[order(rowData(spe_nnSVG)$rank,decreasing = FALSE),][1:10,])

plot_list_hist_gsva_nnsvg <- lapply(top_nnSVG_genesets, function(x){
  pl <- list(x,plotVisium(res,y_coord = "pxl_col_in_fullres", x_coord = "pxl_row_in_fullres", fill = x, assay = "es",sample_ids=NULL) +  ggtitle(paste0(x," GSVA scores superposed in histological image" ))+ theme(text = element_text(size = 7)))
  pl
})
```

```{r, out.width="300%"}
for (i in 1:length(plot_list_hist_gsva_nnsvg)){
  print(plot_list_hist_gsva_nnsvg[i][[1]][[2]]+cluster_plot)
  print(gsva_clusters_ttests(spe,res,plot_list_hist_gsva_nnsvg[i][[1]][[1]]))
}
```


# Correlation between clusters and genesets

The functions used here are saved in the following file:

```{r}
source(here("GSVA_package","gsva_cluster_tests.R"))
```


```{r, out.width="300%"}

most_corr<-most_cor_geneset(spe,res)
corr_plots <- lapply(1:length(unique(colData(spe)$label)), function(x){
  pl <- plotVisium(res,y_coord = "pxl_col_in_fullres", x_coord = "pxl_row_in_fullres", fill = most_corr[x], assay = "es",sample_ids=NULL) + labs(subtitle=NULL)+ggtitle(paste0(most_corr[x]," GSVA scores (most correlated with cluster ",x,")" ))+ theme(text = element_text(size = 7))
  })

for (i in 1:length(corr_plots)){
  print(corr_plots[[i]]+cluster_plot)
}

```



# Compute and plot gradients

```{r}
source("~/spGSVAworkingNotes/GSVA_package/gradients.R")
```

```{r}

plot_gradients <- lapply(top_nnSVG_genesets, function(x){
  pl <- list(x,plotVisium(res,y_coord = "pxl_col_in_fullres", x_coord = "pxl_row_in_fullres", fill = x, assay = "gradients",sample_ids=NULL) +  ggtitle(paste0(x,"Gradients of GSVA scores superposed in histological image" ))+ theme(text = element_text(size = 7)))
  pl
})
```

```{r, out.width="300%"}
for (i in 1:length(plot_gradients)){
  print(plot_gradients[i][[1]][[2]]+cluster_plot)
}
```







