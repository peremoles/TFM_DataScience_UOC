---
title: "GSVA for SpatialExperiment class"
output: html_document
author: "Pere Moles"
date: "2024-04-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warnings = FALSE)
```

# LIBRARIES

```{r}
options(timeout=180)
library(TENxVisiumData)
library(ggspavis)
library(openxlsx)
library(dplyr)
library(abind)
library(scran)
library(scater)
library(SpatialExperiment)
library(SpatialFeatureExperiment)
library(Voyager)
library(GSVA)
```

# LOAD DATA
```{r}
spe <- MouseBrainSagittalAnterior()
spe <- spe[, colData(spe)$sample_id == "MouseBrainSagittalAnterior1"]
```

# PREPROCESSING
## QC

Subset to keep only spots over tissue
```{r}
spe <- spe[, int_colData(spe)$spatialData$in_tissue == TRUE]
```

Identify mitochondrial genes
```{r}
is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$symbol)
spe <- addPerCellQC(spe, subsets = list(mito = is_mito))
```

Select QC thresholds
sum: Library size (represents the total sum of UMI counts per spot).
detected: The number of expressed features (refers to the number of genes with non-zero UMI counts per spot).
subsets_mito_percent: A high proportion of mitochondrial reads indicates cell damage.

To select the QC thresholds we first plot them and choose the thresholds visually.

```{r}
hist(colData(spe)$sum, breaks = 20)
hist(colData(spe)$detected, breaks = 20)
hist(colData(spe)$subsets_mito_percent, breaks = 20)

```


```{r}
qc_lib_size <- colData(spe)$sum < 2000
qc_detected <- colData(spe)$detected < 1000
qc_mito <- colData(spe)$subsets_mito_percent > 30
#qc_cell_count <- colData(spe)$cell_count > 10
```

Number of discarded spots for each metric
```{r}
apply(cbind(qc_lib_size, qc_detected, qc_mito), 2, sum)

discard <- qc_lib_size | qc_detected | qc_mito
table(discard)

colData(spe)$discard <- discard
```

Plot discarded spots

```{r}
# check spatial pattern of combined set of discarded spots
plotVisium(spe, x_coord = "pxl_row_in_fullres", y_coord = "pxl_col_in_fullres",
           fill = "discard")
```

Filter low-quality spots
```{r}
spe <- spe[, !colData(spe)$discard]
```




## NORMALIZATION

```{r}
spe <- computeLibraryFactors(spe)
spe <- logNormCounts(spe)
```

## FEATURE SELECTION

```{r}
spe <- spe[!is_mito, ]
```

Now, let's keep only highly variable genes.

```{r}
# fit mean-variance relationship
dec <- modelGeneVar(spe, assay.type = "logcounts")
```

```{r}
# select top HVGs
top_hvgs <- getTopHVGs(dec, prop = 0.9)
spe <- spe[rownames(spe) %in% top_hvgs,]
```

```{r}
fit <- metadata(dec)
plot(fit$mean, fit$var, 
     xlab = "mean of log-expression", ylab = "variance of log-expression")
curve(fit$trend(x), col = "dodgerblue", add = TRUE, lwd = 2)
```
# Anatomical regions

## Non-spatial clustering

#### PCA

```{r}
# compute PCA
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs)

reducedDimNames(spe)
```


```{r}
# graph-based clustering
set.seed(123)
k <- 28
g <- buildSNNGraph(spe, k = k, use.dimred = "PCA")
g_walk <- igraph::cluster_walktrap(g)
clus <- g_walk$membership
table(clus)
colLabels(spe) <- factor(clus)

```





```{r}
saveRDS(spe, file="spe.rds")
```


# LOAD GENE SETS

Cellmarker data from http://bio-bigdata.hrbmu.edu.cn/CellMarker/CellMarker_download.html
```{r}
cellmarkers <- read.xlsx('Cell_marker_Mouse.xlsx', rowNames =F)
cellmarkers %>% filter(tissue_class=='Brain' & cell_type=="Normal cell") %>% count(cell_name) %>% arrange(desc(n)) %>% head()
```
Extract Gene Set info from the xlsx file
```{r}
cell_types <- cellmarkers %>% filter(tissue_class=='Brain' & cell_type=="Normal cell") %>% count(cell_name) %>% arrange(desc(n)) %>% filter(n>1) %>% select(cell_name)
cell_types <- cell_types$cell_name


# filter genes symbol info on the xlsx file
cm_sets <- lapply(cell_types, function(x) cellmarkers %>% 
                    filter(tissue_class=='Brain' & 
                             cell_type=="Normal cell" &
                             cell_name==x &
                             !(is.na(Symbol)))  %>% pull(Symbol) %>% unique())

cell_types <- unique(make.names(cell_types))
names(cm_sets) <- cell_types
set_names <- names(cm_sets)
```
Create list with geneset names from SpatialExperiment object
```{r}
genesetlist <- lapply(set_names, function(x) {
  geneset <- rownames(rowData(spe)[rowData(spe)$symbol %in% cm_sets[[x]], ,drop=FALSE])
})

names(genesetlist) <- set_names
genesetlist <- genesetlist[sapply(genesetlist, function(x) length(x) > 1)]
```

```{r}
saveRDS(genesetlist, file="genesets.rds")
```















